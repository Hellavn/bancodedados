CREATE DATABASE bd1702
GO

USE bd1702
GO

SET DATEFORMAT DMY
GO

----------------------------------------------------------------------------
------------------------ CRIAÇÃO DE TABELAS --------------------------------
----------------------------------------------------------------------------


-- TABELA CUSTOMER
CREATE TABLE CUSTOMER(
     CUS_CODE       INT PRIMARY KEY,
     CUS_LNAME      VARCHAR(50)         NOT NULL,
     CUS_FNAME      VARCHAR(30)         NOT NULL,
     CUS_INITIAL    CHAR(1),
     CUS_AREACODE   DECIMAL(3),
     CUS_PHONE      CHAR(11)            NOT NULL,
     CUS_BALANCE    DECIMAL(10,2)         DEFAULT 0.00,
     CONSTRAINT CUS_ONLY1NAME UNIQUE(CUS_LNAME, CUS_FNAME)
)
GO

-- Cria a tabela VENDOR
CREATE TABLE VENDOR(
     V_CODE         INT PRIMARY KEY,
     V_NAME         VARCHAR(30)         NOT NULL,
     V_CONTACT      VARCHAR(30)         NOT NULL,
     V_AREACODE     DECIMAL(5),
     V_PHONE        CHAR(11)            NOT NULL,
     V_STATE        CHAR(2),
     V_ORDER        CHAR(1)
)
GO

-- TABELA INVOICE

CREATE TABLE INVOICE (
     INV_NUMBER     INT PRIMARY KEY,
     CUS_CODE       INT FOREIGN KEY REFERENCES CUSTOMER(CUS_CODE),
     INV_DATE       CHAR(11)
)
GO

-- TABELA PRODUCTS
CREATE TABLE PRODUCTS (
     P_CODE         VARCHAR(50) PRIMARY KEY,
     P_DESCRIPT     VARCHAR(255)    NOT NULL,
     P_INDATE       CHAR(11),
     P_QOH          DECIMAL(4)      NOT NULL,
     P_MIN          DECIMAL(4)      NOT NULL,
     P_PRICE        DECIMAL(5,2)     DEFAULT 0.00,
     P_DISCOUNT     DECIMAL(5,2)     DEFAULT 0.00,
     V_CODE         INT FOREIGN KEY REFERENCES VENDOR(V_CODE)
)
GO

-- TABELA LINE
CREATE TABLE LINE(
     INV_NUMBER     INT FOREIGN KEY REFERENCES INVOICE(INV_NUMBER),
     LINE_NUMBER    INT         NOT NULL,
     P_CODE         VARCHAR(50) FOREIGN KEY REFERENCES PRODUCTS(P_CODE),
     LINE_UNITS     DECIMAL(3),
     LINE_PRICE     DECIMAL(5,2)     DEFAULT 0.00
     PRIMARY KEY(INV_NUMBER,LINE_NUMBER)
)
GO


----------------------------------------------------------------------------
------------------- INSERIR VALORES NAS TABELAS ----------------------------
----------------------------------------------------------------------------



-- TABELA CUSTOMER     
INSERT INTO CUSTOMER VALUES (10010, 'Ramas', 'Alfred', 'A', 615, '844-2573',0.00)
INSERT INTO CUSTOMER VALUES (10011, 'Dunne', 'Leona', 'K', 713, '894-1238', 0.00)
INSERT INTO CUSTOMER VALUES (10012, 'Smith', 'Kathy', 'W', 615, '894-2285', 345.86)
INSERT INTO CUSTOMER VALUES (10013, 'Clowski', 'Paul', 'F', 615, '894-2180', 536.75)
INSERT INTO CUSTOMER VALUES (10014, 'Orlando', 'Myron', NULL ,615, '222-1672', 0.00)
INSERT INTO CUSTOMER VALUES (10015, 'OBrian', 'Amy', 'B', 713, '442-3381', 0.00)
INSERT INTO CUSTOMER VALUES (10016, 'Brown', 'James', 'G', 615, '297-1228', 221.19)
INSERT INTO CUSTOMER VALUES (10017, 'Willians', 'George', NULL , 615, '290-2556', 768.93)
INSERT INTO CUSTOMER VALUES (10018, 'Farriss', 'Anne', 'G', 713, '382-7185', 216.55)
INSERT INTO CUSTOMER VALUES (10019, 'Smith', 'Olette', 'K', 615, '297-3809', 0.00)
GO

-- TABELA VENDOR
INSERT INTO VENDOR VALUES (21225, 'Bryson,Inc.', 'Smithson', 615, '223-3234', 'TN', 'Y')
INSERT INTO VENDOR VALUES (21226, 'SuperLoo,Inc.', 'Flushing', 904, '215-8995', 'FL', 'N')
INSERT INTO VENDOR VALUES (21231, 'D&E Supply', 'Singh', 615, '228-3245', 'TN', 'Y')
INSERT INTO VENDOR VALUES (21344, 'Gomez Bros.', 'Ortega', 615, '889-2546', 'KY', 'N')
INSERT INTO VENDOR VALUES (22567, 'Dome Supply', 'Smith', 901, '678-1419', 'GA', 'N')
INSERT INTO VENDOR VALUES (23119, 'Randsets Ltd.', 'Anderson', 901, '678-3998', 'GA', 'Y')
INSERT INTO VENDOR VALUES (24004, 'Brackman Bros.', 'Browning', 615, '228-1410', 'TN', 'N')
INSERT INTO VENDOR VALUES (24288, 'ORDVA,Inc.', 'Hackford', 615, '898-1234', 'TN', 'Y')
INSERT INTO VENDOR VALUES (25443, 'B&K,Inc.', 'Smith', 904, '227-0093', 'FL', 'N')
INSERT INTO VENDOR VALUES (25501, 'Damal SUpplies', 'Smythe', 615, '890-3529', 'TN', 'N')
INSERT INTO VENDOR VALUES (25595, 'Rubicon Systems', 'Orton', 904, '456-0092', 'FL', 'Y')
GO

-- tabela INVOICE    
INSERT INTO INVOICE VALUES (1001, 10014, '16-Mar-08')
INSERT INTO INVOICE VALUES (1002, 10011, '16-Mar-08')
INSERT INTO INVOICE VALUES (1003, 10012, '16-Mar-08')
INSERT INTO INVOICE VALUES (1004, 10011, '17-Mar-08')
INSERT INTO INVOICE VALUES (1005, 10018, '17-Mar-08')
INSERT INTO INVOICE VALUES (1006, 10014, '17-Mar-08')
INSERT INTO INVOICE VALUES (1007, 10015, '17-Mar-08')
INSERT INTO INVOICE VALUES (1008, 10011, '17-Mar-08')
GO

-- TABELA PRODUCTS
INSERT INTO PRODUCTS VALUES('11QER/31', 'Power Point, 15 psi., 3-nozzle', '03-Nov-07', 8, 5, 109.99, 0.00, 25595)
INSERT INTO PRODUCTS VALUES('13-Q2/P2', '7.25-in.pwr.saw blade', '13-Dec-07', 32, 15, 14.99, 0.05, 21344)
INSERT INTO PRODUCTS VALUES('14-Q1/L3', '9.00-in.pwr.saw blade', '13-Nov-07', 18, 12, 17.49, 0.00, 21344)
INSERT INTO PRODUCTS VALUES('1546-QQ2', 'Hrd.cloth,1/4-in,2x50', '15-Jan-08', 15, 8, 39.95, 0.00, 23119)
INSERT INTO PRODUCTS VALUES('1558-QW1', 'Hrd.cloth,1/2-in,3x50', '15-Jan-08', 23, 5, 43.99, 0.00, 23119)
INSERT INTO PRODUCTS VALUES('2232/QTY', 'B&D jigsaw,12-in.blade', '30-Dec-07', 8, 5, 109.92, 0.05, 24288)
INSERT INTO PRODUCTS VALUES('2232/QWE', 'B&D jigsaw,8-in.blade', '24-Dec-07', 6, 5, 99.87, 0.05, 24288)
INSERT INTO PRODUCTS VALUES('2238/QPD', 'B&D cordless drill, 1/2-in.', '20-Jan-08', 12, 5, 38.95, 0.05, 25595)
INSERT INTO PRODUCTS VALUES('23109-HB', 'Claw hammer', '20-Jan-08', 23, 10, 9.95, 0.10, 21225)
INSERT INTO PRODUCTS VALUES('23114-AA', 'Sledge hammer, 12lb.', '02-Jan-08', 8, 5, 14.40, 0.05, NULL)
INSERT INTO PRODUCTS VALUES('54778-2T', 'Rat-tail file, 1/8-in.fine', '15-Dec-07', 43, 20, 4.99, 0.00, 21344)
INSERT INTO PRODUCTS VALUES('89-WRE-Q', 'Hicut chain saw, 16in.', '07-Feb-08', 11, 5, 256.99, 0.05, 24288)
INSERT INTO PRODUCTS VALUES('PVC23DRT', 'PVC pipe, 3.5-in, 8-ft', '20-Feb-08', 188, 75, 5.87, 0.00, NULL)
INSERT INTO PRODUCTS VALUES('SM-18277', '1.25-in.metal screw, 25', '01-Marc-08', 172, 75, 6.99, 0.00, 21225)
INSERT INTO PRODUCTS VALUES('SW-23116', '2.5-in.wd.screw, 50', '24-Feb-08', 237, 100, 8.45, 0.00, 21231)
INSERT INTO PRODUCTS VALUES('WR3/IT3', 'Steel matting, 4x8x1/6", 5" mesh', '17-Jan-08', 18, 5, 119.95, 0.10, 25595)
GO

-- TABELA LINE
INSERT INTO LINE VALUES (1001, 1, '13-Q2/P2', 1, 14.99)
INSERT INTO LINE VALUES (1001, 2, '23109-HB', 1, 9.95)
INSERT INTO LINE VALUES (1002, 1, '54778-2T', 2, 4.99)
INSERT INTO LINE VALUES (1003, 1, '2238/QPD', 1, 38.95)
INSERT INTO LINE VALUES (1003, 2, '1546-QQ2', 1, 39.95)
INSERT INTO LINE VALUES (1003, 3, '13-Q2/P2', 5, 14.99)
INSERT INTO LINE VALUES (1004, 1, '54778-2T', 3, 4.99)
INSERT INTO LINE VALUES (1004, 2, '23109-HB', 2, 9.95)
INSERT INTO LINE VALUES (1005, 1, 'PVC23DRT', 12, 5.87)
INSERT INTO LINE VALUES (1006, 1, 'SM-18277', 3, 6.99)
INSERT INTO LINE VALUES (1006, 2, '2232/QTY', 1, 109.92)
INSERT INTO LINE VALUES (1006, 3, '23109-HB', 1, 9.95)
INSERT INTO LINE VALUES (1006, 4, '89-WRE-Q', 1, 256.99)
INSERT INTO LINE VALUES (1007, 1, '13-Q2/P2', 2, 14.99)
INSERT INTO LINE VALUES (1007, 2, '54778-2T', 1, 4.99)
INSERT INTO LINE VALUES (1008, 1, 'PVC23DRT', 5, 5.87)
INSERT INTO LINE VALUES (1008, 2, 'WR3/IT3', 3, 119.95)
INSERT INTO LINE VALUES (1008, 3, '23109-HB', 1, 9.95)
GO


----------------------------------------------------------------------------
---------------------------- EXERCICIOS ------------------------------------
----------------------------------------------------------------------------



SELECT * FROM CUSTOMER

-- QUESTÃO 16--
	select count(*) from INVOICE 
	GO

-- QUESTÃO 17--
	select count(*) from CUSTOMER
	Where CUS_BALANCE >  500
	GO

-- QUESTÃO 18 --


SELECT	C.CUS_CODE AS 'CÓDIGO DO CLIENTE',	
		I.INV_NUMBER AS 'NUMERO DE PARCELAS',
		I.INV_DATE AS 'DATA DAS PARCELAS',
		P.P_DESCRIPT AS 'DESCRIÇÃO DO PRODUTO',
		L.LINE_UNITS	AS 'UNIDADAES',
		L.LINE_PRICE AS 'PREÇO'
FROM LINE L
INNER JOIN INVOICE I ON I.INV_NUMBER  = L.INV_NUMBER
INNER JOIN CUSTOMER C ON C.CUS_CODE = I.CUS_CODE
INNER JOIN PRODUCTS P ON P.P_CODE = L.P_CODE
ORDER BY C.CUS_CODE 

-- QUESTÃO 19 --


SELECT	C.CUS_CODE AS 'CÓDIGO DO CLIENTE',	
		I.INV_NUMBER AS 'NUMERO DE PARCELAS',
		P.P_DESCRIPT AS 'DESCRIÇÃO DO PRODUTO',
		L.LINE_UNITS	AS 'UNIDADAES',
		L.LINE_PRICE AS 'PREÇO',
		SUM(L.LINE_UNITS * L.LINE_PRICE) AS 'SUBTOTAL'
FROM LINE AS L
		INNER JOIN INVOICE I ON I.INV_NUMBER  = L.INV_NUMBER
		INNER JOIN CUSTOMER C ON C.CUS_CODE = I.CUS_CODE
		INNER JOIN PRODUCTS P ON P.P_CODE = L.P_CODE
	GROUP BY C.CUS_CODE, I.INV_NUMBER, P.P_DESCRIPT, L.LINE_UNITS, L.LINE_PRICE 
ORDER BY C.CUS_CODE 
GO

--USE DATABASE teste1
--GO

-- QUESTÃO 20 --

SELECT	C.CUS_CODE AS 'CÓDIGO DO CLIENTE',	
		C.CUS_BALANCE AS 'BALANCE',		
		SUM(L.LINE_UNITS * L.LINE_PRICE) AS 'SUBTOTAL'
FROM LINE L
		INNER JOIN INVOICE I ON I.INV_NUMBER = L.INV_NUMBER
		INNER JOIN CUSTOMER C ON C.CUS_CODE = I.CUS_CODE
GROUP BY C.CUS_CODE, C.CUS_BALANCE
ORDER BY C.CUS_CODE 
GO


-- QUESTÃO 21 --
SELECT INVOICE.CUS_CODE, CUSTOMER.CUS_BALANCE, Sum(LINE.LINE_UNITS*LINE.LINE_PRICE) AS 'Total Purchases',
	Count(*) AS 'Number of Purchases'	FROM CUSTOMER, INVOICE, LINE
	WHERE INVOICE.INV_NUMBER = LINE.INV_NUMBER AND CUSTOMER.CUS_CODE = INVOICE.CUS_CODE
GROUP BY INVOICE.CUS_CODE, CUSTOMER.CUS_BALANCE
GO
-- QUESTÃO 22 --
SELECT INVOICE.CUS_CODE, CUSTOMER.CUS_BALANCE, 
Sum(LINE.LINE_UNITS*LINE.LINE_PRICE) AS 'Total Purchases', Count(*) AS 'Number of Purchases',
AVG(LINE.LINE_UNITS*LINE.LINE_PRICE) AS 'Average Purchase Amount'
FROM CUSTOMER, INVOICE, LINE
	WHERE INVOICE.INV_NUMBER = LINE.INV_NUMBER AND CUSTOMER.CUS_CODE = INVOICE.CUS_CODE
GROUP BY INVOICE.CUS_CODE, CUSTOMER.CUS_BALANCE
GO

-- QUESTÃO 23 -- 
SELECT LINE.INV_NUMBER, Sum(LINE.LINE_UNITS*LINE.LINE_PRICE) AS 'Invoice Total'
FROM LINE
GROUP BY LINE.INV_NUMBER
GO

-- QUESTÃO 24 --
SELECT CUS_CODE, LINE.INV_NUMBER AS INV_NUMVER, Sum(LINE.LINE_UNITS*LINE.LINE_PRICE) AS 'Invoice Total'
FROM INVOICE, LINE
	WHERE INVOICE.INV_NUMBER = LINE.INV_NUMBER
GROUP BY CUS_CODE, LINE.INV_NUMBER
GO


-- 27)
SELECT CUS_CODE, CUS_BALANCE
FROM CUSTOMER WHERE CUSTOMER.CUS_CODE IN (SELECT DISTINCT
CUS_CODE FROM INVOICE )
-- 28)
SELECT		MIN(CUS_BALANCE) AS 'Minimum Balance',
			MAX(CUS_BALANCE) AS 'Maimum Balance',
			AVG(CUS_BALANCE) AS 'Average Balance'
 FROM CUSTOMER WHERE CUSTOMER.CUS_CODE IN (SELECT
DISTINCT CUS_CODE FROM INVOICE)
GO

-- QUESTÃO 29
SELECT			Sum(CUS_BALANCE) AS 'Total Balance',
				Min(CUS_BALANCE) AS 'Minimum Balance',
				Max(CUS_BALANCE) AS 'Maximum Balance',
				Avg(CUS_BALANCE) AS 'Average Balance'
FROM CUSTOMER
GO

-- QUESTÃO 30
SELECT CUS_CODE, CUS_BALANCE
FROM CUSTOMER 
		WHERE CUSTOMER.CUS_CODE NOT IN (SELECT DISTINCT CUS_CODE FROM INVOICE)
GO

-- QUESTÃO 31
SELECT			SUM(CUS_BALANCE) AS 'Total Balance',
				MIN(CUS_BALANCE) AS 'Minimum Balance',
				MAX(CUS_BALANCE) AS 'Maximum Balance',
				AVG(CUS_BALANCE) AS 'Average Balance'
FROM CUSTOMER 
WHERE CUSTOMER.CUS_CODE NOT IN (SELECT DISTINCT CUS_CODE FROM INVOICE)
GO


-- QUESTÃO 32
SELECT P_DESCRIPT, P_QOH, P_PRICE, P_QOH*P_PRICE AS 'Subtotal'
FROM PRODUCT
GO

-- QUESTÃO 32
SELECT SUM(P_QOH*P_PRICE) AS 'Total Value of Inventory'
	FROM PRODUCT
GO

